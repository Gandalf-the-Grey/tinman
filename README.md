
# Overview

This repository contains utilities to create a testnet.

`snapshot.py` : Gets account data and other data from the blockchain as necessary to do offline initialization of testnet
`txgen.py` : Translate the output of `snapshot.py` to a set of transactions to perform offline initialization of testnet
`submit.py` : Submit the output of `txgen.py` to testnet node

Example usage to set up testnet.

# Mainnet steemd

First, we set up a `steemd` for the main network.  This `steemd` must be the following characteristics:

- The `steemd` must be `appbase` version
- The `chain`, `webserver` and `database_api` plugins must be enabled
- The `webserver-http-endpoint` assumed by the following examples is `127.0.0.1:8090`
- If a snapshot at a well-defined single point in time is desired, no seed nodes should be used, so it does not connect to the p2p network

# Taking a snapshot

```
./snapshot.py -s http://127.0.0.1:8090 -o snapshot.json
```

As of this writing, the above command takes approximately 5 minutes, writing an approximately 1 GB JSON file with 500,000 lines.
If you're running `snapshot.py` interactively and you would like a visual progress indicator, you can install the `pv` program
(`apt-get install pv`) and use it to display the output line count in real time:

```
./snapshot.py -s http://127.0.0.1:8090 | pv -l > snapshot.json
```

# Generating transactions

Now you can use `txgen.py` to create a list of transactions to create and fund the accounts:

```
./txgen.py -c txgen.conf -o tn.txlist      # warning: consumes 4GB of RAM
```

Some notes about the `txgen.py` tool:

- All accounts have `porter` as an additional authority, allowing the testnet creator to act as any account on the testnet
- The private keys for `porter` and other accounts are deterministically created based on the `secret` option in the config file
- Balances are created by dividing `total_port_balance` proportionally among the live STEEM and vesting, subject to `min_vesting_per_account`.
- Therefore, testnet balance is not equal to mainnet balance.  Rather, it is proportional to mainnet balance.
- Accounts listed in `txgen.conf` are considered system accounts and aren't ported

# Running testnet init node

Now that the transactions have been created, let's use them to initialize a testnet.
Since many blocks worth of transactions are created, the `submit.py` script will
use `debug_node_plugin` to generate blocks in the past as rapidly as possible.
So we will run a special node, let's call it the "init node", with the debug plugin
enabled.  The init node is only used to initialize the network.  Later, one or more
normal witness nodes will connect to the init node over p2p, get blocks, and begin
normal block production.

- The `steemd` must be `appbase` version
- The testnet `blockchain` directory should be empty (try `rm -Rf testnet_datadir/blockchain`)
- The following plugins should be enabled:  `chain p2p webserver debug_node database_api network_broadcast_api debug_node_api block_api`
- The `webserver-http-endpoint` assumed by the following examples is `127.0.0.1:9990`
- It must contain functionality from PR's #1722 #1723
- It should listen for p2p, the following examples assume it is listening on `0.0.0.0:12001`

On the testnet, some serializations are different from the main network, and
[they are not handled properly by steem_python](https://github.com/steemit/steem-python/issues/89).
Therefore, `submit.py` outsources signing of those transactions to the
`sign_transaction` binary included with `steemd`:

```
./submit.py -t http://127.0.0.1:9990 --signer steem/programs/util/sign_transaction -f fail.json
```

# Running testnet witness node(s)

At the end of the transactions to be submitted, `txgen.py` creates witnesses `init-0` through `init-19`
and votes for them with large amount of `TESTS`.  The keys of these witnesses are generated by a deterministic
algorithm compatible with the `get_dev_key` utility program, so the keys of the witnesses may be obtained
as follows:

```
programs/util/get_dev_key xxx- block-init-0:20
```

where `xxx` is the `"secret"` string in `txgen.conf`.

So in order to transition block production duties away from the initial node, all that is required
is to connect witness nodes with the correct block production settings.  Each witness node should
specify the init node using the `p2p-seed-node` option in the config file.

Therefore we may add the witness definitions and private keys to the witness config file:

```
i=0 ; while [ $i -lt 20 ] ; do echo witness = '"'init-$i'"' >> testnet_datadir/config.ini ; let i=i+1 ; done
steem/programs/util/get_dev_key xxx- block-init-0:20 | cut -d '"' -f 4 | sed 's/^/private-key = /' >> testnet_datadir/config.ini
```

Witness duties may of course be split among multiple nodes if desired, simply put the
`witness` and `private-key` definitions in the datadir of each node, and have each
witness node connect to all the others with the `p2p-seed-node` option.

Additionally, because there is a large gap in block timestamps between the end of the
initialization blocks and the beginning of normal production, the witness will need
to specify `--enable-stale-production` and `--required-participation=0` flags.  As
long as a sufficient number of other witness nodes are timely producing blocks, it
is not necessary to use these flags once 128 blocks have been produced after the
transition.
